{% load staticfiles %}
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="{% static "service/libraries/jquery/jquery-2.0.0.min.js" %}"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="{% static "service/libraries/bootstrap/js/bootstrap.min.js"%} "></script>

<!-- Plugins -->
<script src="{% static "service/libraries/plugins/jquery.lazyload.min.js"%} "></script>

<script src="{% static "service/libraries/angularjs/angular.js" %}"></script>
<script src="{% static "service/libraries/angularjs/angular-route.js" %}"></script>
<script src="{% static "service/libraries/angularjs/angular-ui-router.min.js" %}"></script>


<!-- heroes css -->
<link href="{% static "service/media/_src/_d2/heroes-css-framework.css" %}" rel="stylesheet">


<script>
"use strict";
var demoApp = angular.module('demoApp', ['ui.router']);


//#! factory
//#! Posts
demoApp.factory('ApiFactory', function($http) {
	return {
        get: function(url) {
			return $http.get(url).then(function (response) {
			     if (response.data.error) {
			         return null;
			     } else {
			         //console.log(response.data);
			         return response.data;
			     }
			});
        }
    };
});
//#! Comments

//#! config route
demoApp.config(function($stateProvider, $urlRouterProvider) {
	$urlRouterProvider.otherwise("/posts");
	$stateProvider
		.state('posts', {
			url : '/posts',
			views : {
				'viewPosts' : {
					templateUrl: '/angular/tpl/posts/',
					controller: 'ApiPostsController'
				}
			}
		})
		.state('posts.comments', {
			url : '/:id',
			views : {
				'viewComments' : {
					templateUrl: '/angular/tpl/comments/',
					controller: 'ApiCommentsController'
				}
			}
		});

		
});
 
//#! controller
demoApp.controller('ApiPostsController', function($scope, $state, ApiFactory){	

	$scope.loadFetchData = function(){
		var url = '/api/posts/showByLimit/' + $scope.page + '/' + $scope.limit;
		ApiFactory.get(url).then(function(data) {
			$scope.more = data.length === $scope.limit;
	        $scope.posts = $scope.posts.concat(data);
	    });
    };
    	
	$scope.loadApiPostsCtrl = function(){
		$scope.page += 1;
		$scope.loadFetchData();
	};

	$scope.loadhasMore = function() {
        return $scope.more;
	};

	//# init
	$scope.page = 1;
	$scope.limit = 2;
	$scope.more = true;
	$scope.posts = [];
	$scope.loadFetchData();
	console.log('posts');
	
});


demoApp.controller('ApiCommentsController', function($scope, $state, $stateParams, ApiFactory){		
	
	$scope.loadFetchData = function(){
		var id = $stateParams.id;
		var url = '/api/comments/showById/'+ id;
		ApiFactory.get(url).then(function(data) {
	        $scope.postscomments = $scope.postscomments.concat(data);
	    });
    };

	
	$scope.loadApiCommentsCtrl = function(){
		$('.comm-modal-wrpp-comments').show();	
		$('.comm-side-modal-wrpp-close').on('click', function(){
			$('.comm-modal-wrpp').hide();
			$('.comm-modal-wrpp-comments').hide();	
		});
 	};
	
	//# init
	$scope.postscomments = [];
	$scope.loadApiCommentsCtrl();
	$scope.loadFetchData();
 	console.log('comments');
 	
	
});


/** Ajax Spinner **/
angular.module('services.SharedServices', []).config(function ($httpProvider) {
    $httpProvider.responseInterceptors.push('myHttpInterceptor');
    var spinnerFunction = function (data, headersGetter) {
        $("#loading").show();
        return data;
    };
    $httpProvider.defaults.transformRequest.push(spinnerFunction);
}).factory('myHttpInterceptor', function ($q, $window) {
    return function (promise) {
        return promise.then(function (response) {
            $("#loading").hide();
            return response;
        }, function (response) {
            $("#loading").hide();
            return $q.reject(response);
        });
    };
});
/** Ajax Spinner **/ 

</script>

<script>

	//#! post image lazy
	$('.comm-posts-img-lazy').lazyload({
	    effect : "fadeIn",
	    threshold : 5
	});

	//#! modal post/comments
	$('.comm-open-modal-share').on('click', function(){
		$('.comm-modal-wrpp').show();	
		$('.comm-selection-img-lazy').lazyload({
		    effect : "fadeIn",
		    threshold : 5
		});
	});
	
	$('.comm-side-modal-wrpp-close').on('click', function(){
		$('.comm-modal-wrpp').hide();
		$('.comm-modal-wrpp-comments').hide();	
		resetAll();
	});
	

	$('.comm-open-modal-comments').on('click', function(){
		$('.comm-modal-wrpp-comments').show();	
		$('.comm-comments-img-lazy').lazyload({
		    effect : "fadeIn",
		    threshold : 5
		});
	});
	
	
	//#! menu selection
	$('.comm-prtr-selection-menu').on('click', function(event){
		//#! check if selected
		var allclss = '.comm-prtr-selection-menu';
		var clss =  'comm-prtr-selection-menu-selected';
		$(allclss).removeClass(clss);
		$(this).addClass(clss);
	});
	$('.comm-trgr-selection-menu').on('click', function(){
		var data = $(this).attr('data');
		var json = jQuery.parseJSON(data);
		$('.comm-selection-wrapp').hide();
		$(json.target).show();
	});
	
	//#! reset
	function resetAll(){
		//#! pick type button
		$('.comm-pick-type').removeClass('btn-success');
		$('.comm-pick-type-default').addClass('btn-success');

		//#! hero checkboxes and images
		$('.comm-prtr-selection-btn').removeClass('comm-prtr-selected');
		$('.comm-hero-checkboxes').prop('checked', false);
		//#! pick limit count
		$('.comm-pick-remain').html(5);
		//#! pick type tagging
		$('.comm-lane-checkboxes').prop('checked', false);
		$('.comm-lane-checkboxes-default').prop('checked', true);
	}
	
	//#! pick type selection
	$('.comm-pick-type').on('click', function(){
		resetAll();
		var limit = $('#comm-pick-limit').val($(this).attr('data'));
		$('.comm-pick-type').removeClass('btn-success');
		$(this).addClass('btn-success');
		$('.comm-pick-remain').html($(this).attr('data'));
		
		//#! pick type tagging
		lanetag = $(this).attr('data');
		$('.comm-lane-checkboxes').prop('checked', false);		
		$('#lane-'+lanetag).prop('checked', true);		
		
	});

	//#! hero selection
	$('.comm-prtr-selection-btn').on('click', function(){
		//#! check if selected
		var clss =  'comm-prtr-selected';
		var data = $(this).attr('data');
		var json = jQuery.parseJSON(data);
		var limit = $('#comm-pick-limit');
		var limitValue = limit.val();

		if($(this).hasClass(clss)){
			$(this).removeClass(clss);
			$(json.target).prop('checked', false);
			limit.val( parseInt(limit.val()) + 1);
			$('.comm-pick-remain').html(limit.val());
		}else{
			//#! check if zero
			if (limitValue > 0) {
				$(this).addClass(clss);
				$(json.target).prop('checked', true);
				limit.val(limit.val() - 1);
				$('.comm-pick-remain').html(limit.val());	
			}
		}
		
	});
	
	
	$( "#comm-posts-form" ).submit(function( event ) {
		return true;
	});		
	$( "#comm-posts-form-submit-btn" ).click(function() {
	  $( "#comm-posts-form" ).submit();
	});		


</script>
